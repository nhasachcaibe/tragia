<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#ffffff">
  <link rel="manifest" href="manifest.json">
  <title>Tra Gi√° B·∫±ng ·∫¢nh</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f6f7f9;color:#111}
    header{padding:14px 14px 10px;background:#fff;border-bottom:1px solid #e5e7eb;position:sticky;top:0}
    h1{font-size:16px;margin:0}
    main{padding:14px;max-width:920px;margin:0 auto}
    .tabs{display:flex;gap:8px;margin-top:10px}
    .tab{flex:1;padding:10px;border:1px solid #e5e7eb;background:#fff;border-radius:10px;font-weight:800}
    .tab.active{border-color:#111}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin:12px 0}
    label{display:block;font-size:13px;margin:10px 0 6px}
    input,button{font:inherit}
    input[type="text"],input[type="number"]{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
    input[type="file"]{width:100%}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1;min-width:160px}
    button{padding:11px 12px;border:1px solid #111;background:#111;color:#fff;border-radius:10px;font-weight:900}
    button.secondary{background:#fff;color:#111;border-color:#d1d5db}
    button.danger{background:#b91c1c;border-color:#b91c1c}
    .small{font-size:12px;color:#6b7280;line-height:1.4}
    .status{font-size:13px;margin-top:8px}
    .ok{color:#065f46}
    .bad{color:#b91c1c}
    img.preview{max-width:100%;border-radius:12px;border:1px solid #e5e7eb}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .thumbWrap{display:inline-block;position:relative;margin:2px}
    .thumbs img{width:72px;height:72px;object-fit:cover;border-radius:12px;border:1px solid #e5e7eb}
    .thumbDel{position:absolute;top:-6px;right:-6px;width:22px;height:22px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:900;line-height:20px;padding:0}
    table{width:100%;border-collapse:collapse}
    td,th{border-bottom:1px solid #e5e7eb;padding:8px;text-align:left;font-size:14px;vertical-align:top}
    th{font-size:12px;color:#6b7280;font-weight:900}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb;font-size:12px}
    .scoreLine{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    details{border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fafafa}
    summary{cursor:pointer;font-weight:900}
  </style>
</head>
<body>
<header>
  <h1>Tra gi√° b·∫±ng ·∫£nh (Shape ‚Üí Color) ‚Ä¢ L∆∞u trong iPhone</h1>
  <div class="tabs">
    <button class="tab active" id="tabAdd" type="button">‚ûï Th√™m SP</button>
    <button class="tab" id="tabLookup" type="button">üì∑ Tra gi√°</button>
    <button class="tab" id="tabList" type="button">üìö Danh s√°ch</button>
  </div>
</header>

<main>
  <div class="card small">
    <div><b>M·∫πo ch√≠nh x√°c:</b> M·ªói SKU ch·ª•p 2‚Äì3 ·∫£nh (nhi·ªÅu m√†u, nhi·ªÅu g√≥c). Khi tra: <b>h√¨nh 70%</b> + <b>m√†u 30%</b>. C√≥ ng∆∞·ª°ng n√™n ch·ª•p sai s·∫Ω b√°o ‚ÄúKh√¥ng t√¨m th·∫•y‚Äù.</div>
    <div style="margin-top:6px">L·∫ßn ƒë·∫ßu m·ªü c·∫ßn m·∫°ng ƒë·ªÉ t·∫£i model AI. Sau ƒë√≥ d√πng offline (ƒë√£ cache).</div>
  </div>

  <!-- ADD -->
  <section id="viewAdd">
    <div class="card">
      <div class="row">
        <div>
          <label>SKU</label>
          <input id="sku" type="text" placeholder="VD: THUBONG-01" autocomplete="off" />
        </div>
        <div>
          <label>Gi√°</label>
          <input id="price" type="number" placeholder="VD: 45000" />
        </div>
      </div>

      <label>T√™n (tu·ª≥ ch·ªçn)</label>
      <input id="name" type="text" placeholder="VD: M√≥c kho√° th√∫ nh·ªìi b√¥ng" autocomplete="off" />

      <label>Ch·ª•p / ch·ªçn ·∫£nh (1‚Äì3 ·∫£nh/l·∫ßn)</label>
      <input id="addPhotos" type="file" accept="image/*" capture="environment" multiple />
      <div class="small">C√≥ th·ªÉ nh·∫≠p l·∫°i ƒë√∫ng SKU r·ªìi ch·ª•p th√™m ƒë·ªÉ <b>c·ªông ·∫£nh</b> (th√™m nhi·ªÅu m√†u).</div>

      <div class="row" style="margin-top:12px">
        <button id="btnSave" type="button">L∆∞u / C·∫≠p nh·∫≠t SKU</button>
        <button id="btnInitModel" class="secondary" type="button">T·∫£i/kh·ªüi ƒë·ªông AI</button>
      </div>

      <div id="addThumbPreview" class="thumbs"></div>
      <div id="addStatus" class="status"></div>
    </div>
  </section>

  <!-- LOOKUP -->
  <section id="viewLookup" style="display:none">
    <div class="card">
      <label>Ch·ª•p ·∫£nh ƒë·ªÉ tra SKU + gi√°</label>
      <input id="lookupPhoto" type="file" accept="image/*" capture="environment" />
      <div class="small">N·∫øu s·∫£n ph·∫©m gi·ªëng nhau nhi·ªÅu, tr·∫£ <b>Top 5</b>.</div>
      <div id="lookupStatus" class="status"></div>
      <div id="lookupPreview" style="margin-top:10px"></div>
      <div id="lookupResult" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- LIST -->
  <section id="viewList" style="display:none">
    <div class="card">
      <div class="row">
        <button id="btnExport" class="secondary" type="button">Xu·∫•t d·ªØ li·ªáu (backup)</button>
        <label style="flex:2;min-width:240px">
          Nh·∫≠p d·ªØ li·ªáu (restore)
          <input id="importFile" type="file" accept="application/json" />
        </label>
      </div>
      <div class="small">N√™n export ƒë·ªãnh k·ª≥ ƒë·ªÉ kh·ªèi m·∫•t d·ªØ li·ªáu khi ƒë·ªïi m√°y / reset Safari.</div>
    </div>

    <div class="card">
      <div class="row">
        <input id="search" type="text" placeholder="T√¨m theo SKU / t√™n..." />
        <button id="btnClearAll" class="danger" type="button">Xo√° to√†n b·ªô</button>
      </div>
      <div id="listStatus" class="status"></div>
      <div id="listTable"></div>
    </div>
  </section>
</main>

<!-- TFJS + MobileNet -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.1/dist/mobilenet.min.js"></script>

<script>
/* =========================
   CONFIG
========================= */
const SHAPE_WEIGHT = 0.70;
const COLOR_WEIGHT = 0.30;
const TOP_K = 5;
const MAX_PHOTOS_PER_ADD = 3;

// Ng∆∞·ª°ng ƒë·ªÉ kh√¥ng tr·∫£ b·ª´a khi ch·ª•p kh√¥ng c√≥ trong th∆∞ vi·ªán
const MIN_SCORE = 0.80;  // t·ªïng
const MIN_SHAPE = 0.72;  // h√¨nh

/* =========================
   IndexedDB helper
========================= */
const DB_NAME = "photo_price_db_v3";
const DB_STORE = "products";

function openDB(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if(!db.objectStoreNames.contains(DB_STORE)){
        const store = db.createObjectStore(DB_STORE, { keyPath: "id" }); // id = p_<sku>
        store.createIndex("sku", "sku", { unique: true });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function dbPut(obj){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(DB_STORE, "readwrite");
    tx.objectStore(DB_STORE).put(obj);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}
async function dbGet(id){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(DB_STORE, "readonly");
    const req = tx.objectStore(DB_STORE).get(id);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror = () => reject(req.error);
  });
}
async function dbGetAll(){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(DB_STORE, "readonly");
    const req = tx.objectStore(DB_STORE).getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
}
async function dbDelete(id){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(DB_STORE, "readwrite");
    tx.objectStore(DB_STORE).delete(id);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}
async function dbClear(){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(DB_STORE, "readwrite");
    tx.objectStore(DB_STORE).clear();
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}

/* =========================
   AI: MobileNet embedding
========================= */
let model = null;

async function initModel(){
  if(model) return model;
  await tf.ready();
  model = await mobilenet.load({version: 2, alpha: 1.0});
  const dummy = tf.zeros([224,224,3]);
  model.infer(dummy, true);
  dummy.dispose();
  return model;
}

function fileToImage(file){
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}

function cosineSim(a, b){
  let dot = 0, na = 0, nb = 0;
  for(let i=0;i<a.length;i++){
    const x = a[i], y = b[i];
    dot += x*y; na += x*x; nb += y*y;
  }
  const denom = (Math.sqrt(na)*Math.sqrt(nb)) || 1e-9;
  return dot / denom;
}

async function embedFromImage(img){
  await initModel();
  const t = tf.tidy(() => {
    const c = document.createElement("canvas");
    c.width = 224; c.height = 224;
    const ctx = c.getContext("2d");
    ctx.drawImage(img, 0, 0, 224, 224);
    const input = tf.browser.fromPixels(c).toFloat().div(255);
    return model.infer(input, true).flatten();
  });
  const arr = await t.data();
  t.dispose();
  return new Float32Array(arr);
}

/* =========================
   Color: dominant RGB (ignore near-white)
========================= */
function getDominantColorFromCanvas(ctx, w, h){
  const data = ctx.getImageData(0,0,w,h).data;
  let r=0,g=0,b=0,count=0;
  for(let i=0;i<data.length;i+=4){
    const rr=data[i], gg=data[i+1], bb=data[i+2], aa=data[i+3];
    if(aa < 200) continue;
    const bright = (rr+gg+bb)/3;
    if(bright > 245) continue;
    r += rr; g += gg; b += bb; count++;
  }
  if(count === 0){
    for(let i=0;i<data.length;i+=4){
      r += data[i]; g += data[i+1]; b += data[i+2]; count++;
    }
  }
  return [r/count, g/count, b/count];
}

function getDominantColor(img){
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  const W=64,H=64;
  canvas.width=W; canvas.height=H;
  ctx.drawImage(img, 0, 0, W, H);
  return getDominantColorFromCanvas(ctx, W, H);
}

function colorDistance(c1, c2){
  const dr = c1[0]-c2[0];
  const dg = c1[1]-c2[1];
  const db = c1[2]-c2[2];
  return Math.sqrt(dr*dr + dg*dg + db*db);
}
function colorScore(queryColor, sampleColor){
  const dist = colorDistance(queryColor, sampleColor);
  const score = 1 - (dist / 441.67295593);
  return Math.max(0, Math.min(1, score));
}

function makeThumbAndColor(img){
  const c = document.createElement("canvas");
  const w = 240, h = 240;
  c.width = w; c.height = h;
  const ctx = c.getContext("2d");
  ctx.fillStyle = "#fff";
  ctx.fillRect(0,0,w,h);
  const r = Math.min(w/img.width, h/img.height);
  const nw = img.width*r, nh = img.height*r;
  ctx.drawImage(img, (w-nw)/2, (h-nh)/2, nw, nh);
  const dom = getDominantColorFromCanvas(ctx, w, h);
  const dataUrl = c.toDataURL("image/jpeg", 0.78);
  return { dataUrl, dom };
}

/* =========================
   UI helpers
========================= */
const el = (id) => document.getElementById(id);

function setStatus(id, msg, ok=true){
  const e = el(id);
  e.className = "status " + (ok ? "ok":"bad");
  e.textContent = msg;
}

function setActiveTab(tab){
  ["tabAdd","tabLookup","tabList"].forEach(t => el(t).classList.toggle("active", t===tab));
  el("viewAdd").style.display = tab==="tabAdd" ? "" : "none";
  el("viewLookup").style.display = tab==="tabLookup" ? "" : "none";
  el("viewList").style.display = tab==="tabList" ? "" : "none";
}

function formatMoney(n){
  try { return Number(n).toLocaleString("vi-VN") + " ƒë"; }
  catch { return n + " ƒë"; }
}

/* =========================
   Data model:
   product = { id:"p_<sku>", sku,name,price, photos:[{thumb,vec,color,updatedAt}], updatedAt }
========================= */

/* =========================
   ADD/UPDATE: c·ªông ·∫£nh cho SKU (nhi·ªÅu m√†u)
========================= */
async function saveOrUpdateProduct(){
  const sku = el("sku").value.trim();
  const price = Number(el("price").value);
  const name = el("name").value.trim();
  const files = el("addPhotos").files;

  if(!sku) return setStatus("addStatus","Vui l√≤ng nh·∫≠p SKU.", false);
  if(!price || price < 0) return setStatus("addStatus","Vui l√≤ng nh·∫≠p gi√° h·ª£p l·ªá.", false);
  if(!files || files.length===0) return setStatus("addStatus","Vui l√≤ng ch·ª•p/ch·ªçn √≠t nh·∫•t 1 ·∫£nh.", false);

  setStatus("addStatus","ƒêang x·ª≠ l√Ω ·∫£nh (shape + m√†u) v√† l∆∞u‚Ä¶", true);
  el("addThumbPreview").innerHTML = "";

  try{
    await initModel();
    const id = "p_" + sku;
    const existing = await dbGet(id);

    const product = existing || { id, sku, name:"", price:0, photos:[], updatedAt:0 };
    product.price = price;
    product.name = name || product.name || "";

    const maxPhotos = Math.min(files.length, MAX_PHOTOS_PER_ADD);

    for(let i=0;i<maxPhotos;i++){
      const f = files[i];
      const img = await fileToImage(f);

      const { dataUrl, dom } = makeThumbAndColor(img);
      el("addThumbPreview").insertAdjacentHTML("beforeend", `<div class="thumbWrap"><img src="${dataUrl}"></div>`);

      const vec = await embedFromImage(img);

      product.photos.push({
        thumb: dataUrl,
        color: dom,
        vec: Array.from(vec),
        updatedAt: Date.now()
      });

      URL.revokeObjectURL(img.src);
    }

    product.updatedAt = Date.now();
    await dbPut(product);

    el("sku").value = "";
    el("price").value = "";
    el("name").value = "";
    el("addPhotos").value = "";

    setStatus("addStatus",`ƒê√£ l∆∞u/c·∫≠p nh·∫≠t SKU: ${product.sku}. T·ªïng ·∫£nh: ${product.photos.length}.`, true);
    await renderList();
  }catch(err){
    console.error(err);
    setStatus("addStatus","L·ªói khi l∆∞u. Ki·ªÉm tra HTTPS/m·∫°ng (l·∫ßn ƒë·∫ßu t·∫£i AI).", false);
  }
}

/* =========================
   LOOKUP: Shape -> Color + ng∆∞·ª°ng "Kh√¥ng t√¨m th·∫•y"
========================= */
async function lookupByPhoto(file){
  if(!file) return;

  setStatus("lookupStatus","ƒêang ph√¢n t√≠ch ·∫£nh‚Ä¶", true);
  el("lookupResult").innerHTML = "";
  el("lookupPreview").innerHTML = "";

  try{
    const img = await fileToImage(file);
    el("lookupPreview").innerHTML = `<img class="preview" src="${img.src}" alt="preview">`;

    await initModel();
    const qVec = await embedFromImage(img);
    const qColor = getDominantColor(img);

    const products = await dbGetAll();
    if(products.length === 0){
      setStatus("lookupStatus","Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y th√™m s·∫£n ph·∫©m tr∆∞·ªõc.", false);
      return;
    }

    const scored = products.map(p => {
      let bestFinal = -1, bestShape = -1, bestColor = -1, bestThumb = p.photos?.[0]?.thumb || "";
      const photos = p.photos || [];

      for(const ph of photos){
        const shape = cosineSim(qVec, new Float32Array(ph.vec));
        const cscore = colorScore(qColor, ph.color);
        const finalScore = (shape * SHAPE_WEIGHT) + (cscore * COLOR_WEIGHT);

        if(finalScore > bestFinal){
          bestFinal = finalScore;
          bestShape = shape;
          bestColor = cscore;
          bestThumb = ph.thumb || bestThumb;
        }
      }

      return { p, score: bestFinal, shape: bestShape, color: bestColor, bestThumb };
    }).sort((a,b)=>b.score-a.score);

    const top = scored.slice(0, TOP_K);

    if(!top.length || top[0].score < MIN_SCORE || top[0].shape < MIN_SHAPE){
      setStatus("lookupStatus","Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ph√π h·ª£p. H√£y th√™m s·∫£n ph·∫©m n√†y v√†o th∆∞ vi·ªán ho·∫∑c ch·ª•p r√µ h∆°n.", false);
      el("lookupResult").innerHTML = "";
      return;
    }

    setStatus("lookupStatus",`Xong ‚úÖ ‚Ä¢ ƒê·ªô kh·ªõp cao nh·∫•t: ${(top[0].score*100).toFixed(1)}%`, true);

    const rows = top.map(({p, score, shape, color, bestThumb}) => `
      <tr>
        <td>${bestThumb ? `<img src="${bestThumb}" style="width:52px;height:52px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb">` : ""}</td>
        <td><b>${p.sku}</b><div class="small">${p.name || ""}</div></td>
        <td><b>${formatMoney(p.price)}</b></td>
        <td>
          <div class="scoreLine">
            <span class="pill">T·ªïng ${(score*100).toFixed(1)}%</span>
            <span class="pill">H√¨nh ${(shape*100).toFixed(1)}%</span>
            <span class="pill">M√†u ${(color*100).toFixed(1)}%</span>
          </div>
        </td>
      </tr>
    `).join("");

    el("lookupResult").innerHTML = `
      <table>
        <thead><tr><th>·∫¢nh kh·ªõp</th><th>S·∫£n ph·∫©m</th><th>Gi√°</th><th>ƒêi·ªÉm</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="small" style="margin-top:8px">
        N·∫øu hay nh·∫ßm m√†u: v√†o <b>Danh s√°ch</b> ‚Üí m·ªü SKU ‚Üí <b>Th√™m ·∫£nh</b> cho m√†u ƒë√≥.
      </div>
    `;

    URL.revokeObjectURL(img.src);
  }catch(err){
    console.error(err);
    setStatus("lookupStatus","L·ªói tra c·ª©u. Th·ª≠ ch·ª•p r√µ h∆°n/ƒë·ªß s√°ng nh√©.", false);
  }
}

/* =========================
   LIST: s·ª≠a t√™n/gi√° + th√™m ·∫£nh + xo√° t·ª´ng ·∫£nh
========================= */
async function renderList(){
  const q = el("search")?.value?.trim().toLowerCase() || "";
  const items = (await dbGetAll())
    .sort((a,b) => (b.updatedAt||0)-(a.updatedAt||0))
    .filter(p => !q || (p.sku||"").toLowerCase().includes(q) || (p.name||"").toLowerCase().includes(q));

  el("listStatus").textContent = `T·ªïng: ${items.length} SKU.`;

  if(items.length===0){
    el("listTable").innerHTML = `<div class="small">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o.</div>`;
    return;
  }

  el("listTable").innerHTML = items.map(p => {
    const n = (p.photos||[]).length;
    const thumbs = (p.photos||[]).map((ph,idx)=>`
      <div class="thumbWrap">
        <img src="${ph.thumb}">
        <button class="thumbDel" type="button" onclick="window.__delPhoto('${p.id}', ${idx})">√ó</button>
      </div>
    `).join("");

    return `
      <details style="margin:10px 0">
        <summary>${p.sku} ‚Ä¢ ${formatMoney(p.price)} ‚Ä¢ ·∫£nh: ${n}</summary>

        <div class="row" style="margin-top:10px">
          <div>
            <label>T√™n</label>
            <input id="ename_${p.id}" type="text" value="${(p.name||"").replaceAll('"','&quot;')}" />
          </div>
          <div>
            <label>Gi√°</label>
            <input id="eprice_${p.id}" type="number" value="${p.price}" />
          </div>
          <div style="min-width:160px">
            <label>&nbsp;</label>
            <button type="button" onclick="window.__saveEdit('${p.id}')">L∆∞u s·ª≠a</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <label style="flex:2;min-width:240px">
            Th√™m ·∫£nh cho SKU n√†y (c·ªông th√™m ·∫£nh)
            <input id="addmore_${p.id}" type="file" accept="image/*" capture="environment" multiple />
          </label>
          <div style="min-width:200px">
            <label>&nbsp;</label>
            <button class="secondary" type="button" onclick="window.__addPhotosToSku('${p.id}')">Th√™m ·∫£nh</button>
          </div>
          <div style="min-width:200px">
            <label>&nbsp;</label>
            <button class="danger" type="button" onclick="window.__delSku('${p.id}')">Xo√° SKU</button>
          </div>
        </div>

        <div class="small" style="margin-top:8px">Xo√° ·∫£nh: b·∫•m d·∫•u <b>√ó</b> tr√™n t·ª´ng ·∫£nh (m·ªói ·∫£nh = 1 m√†u/g√≥c).</div>
        <div class="thumbs">${thumbs || ""}</div>
      </details>
    `;
  }).join("");
}

/* ===== actions in list ===== */
window.__saveEdit = async (id) => {
  const p = await dbGet(id);
  if(!p) return;

  const name = document.getElementById("ename_" + id)?.value?.trim() || "";
  const price = Number(document.getElementById("eprice_" + id)?.value);
  if(!price || price < 0){
    alert("Gi√° kh√¥ng h·ª£p l·ªá");
    return;
  }

  p.name = name;
  p.price = price;
  p.updatedAt = Date.now();
  await dbPut(p);
  await renderList();
};

window.__delPhoto = async (id, idx) => {
  const p = await dbGet(id);
  if(!p) return;
  if(!confirm("Xo√° ·∫£nh n√†y kh·ªèi SKU?")) return;

  p.photos = (p.photos || []).filter((_, i) => i !== idx);
  p.updatedAt = Date.now();

  if(p.photos.length === 0){
    if(confirm("SKU n√†y kh√¥ng c√≤n ·∫£nh n√†o. Xo√° lu√¥n SKU?")){
      await dbDelete(id);
      await renderList();
      return;
    }
  }

  await dbPut(p);
  await renderList();
};

window.__addPhotosToSku = async (id) => {
  const p = await dbGet(id);
  if(!p) return;

  const inp = document.getElementById("addmore_" + id);
  const files = inp?.files;
  if(!files || files.length === 0){
    alert("Ch∆∞a ch·ªçn ·∫£nh");
    return;
  }

  try{
    await initModel();
    const maxPhotos = Math.min(files.length, MAX_PHOTOS_PER_ADD);

    for(let i=0;i<maxPhotos;i++){
      const img = await fileToImage(files[i]);
      const { dataUrl, dom } = makeThumbAndColor(img);
      const vec = await embedFromImage(img);

      p.photos.push({
        thumb: dataUrl,
        color: dom,
        vec: Array.from(vec),
        updatedAt: Date.now()
      });

      URL.revokeObjectURL(img.src);
    }

    p.updatedAt = Date.now();
    await dbPut(p);

    inp.value = "";
    await renderList();
    alert("ƒê√£ th√™m ·∫£nh cho SKU: " + p.sku);
  }catch(e){
    console.error(e);
    alert("L·ªói khi th√™m ·∫£nh. Ki·ªÉm tra m·∫°ng/HTTPS (l·∫ßn ƒë·∫ßu t·∫£i AI).");
  }
};

window.__delSku = async (id) => {
  const p = await dbGet(id);
  if(!p) return;
  if(!confirm("Xo√° SKU n√†y v√† to√†n b·ªô ·∫£nh?")) return;
  await dbDelete(id);
  await renderList();
};

/* =========================
   Export / Import
========================= */
async function exportData(){
  const items = await dbGetAll();
  const blob = new Blob([JSON.stringify({version:3, exportedAt:Date.now(), items}, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `backup-tra-gia-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

async function importData(file){
  if(!file) return;
  const text = await file.text();
  const data = JSON.parse(text);
  const items = data.items || [];
  for(const it of items){
    if(it && it.id && it.sku && typeof it.price === "number" && Array.isArray(it.photos)){
      it.photos = it.photos
        .filter(ph => ph && Array.isArray(ph.vec) && Array.isArray(ph.color) && typeof ph.thumb === "string")
        .map(ph => ({ thumb: ph.thumb, vec: ph.vec, color: ph.color, updatedAt: ph.updatedAt || Date.now() }));
      it.updatedAt = it.updatedAt || Date.now();
      await dbPut(it);
    }
  }
  await renderList();
  alert("ƒê√£ nh·∫≠p xong d·ªØ li·ªáu.");
}

/* =========================
   Tabs + events
========================= */
el("tabAdd").onclick = () => setActiveTab("tabAdd");
el("tabLookup").onclick = () => setActiveTab("tabLookup");
el("tabList").onclick = () => { setActiveTab("tabList"); renderList(); };

el("btnInitModel").onclick = async () => {
  setStatus("addStatus","ƒêang t·∫£i/kh·ªüi ƒë·ªông AI‚Ä¶", true);
  try{ await initModel(); setStatus("addStatus","AI s·∫µn s√†ng ‚úÖ", true); }
  catch(e){ console.error(e); setStatus("addStatus","Kh√¥ng t·∫£i ƒë∆∞·ª£c AI. Ki·ªÉm tra m·∫°ng/HTTPS.", false); }
};

el("btnSave").onclick = saveOrUpdateProduct;

el("lookupPhoto").addEventListener("change", (e) => {
  const file = e.target.files?.[0];
  if(file) lookupByPhoto(file);
});

el("btnExport").onclick = exportData;
el("importFile").addEventListener("change", (e) => importData(e.target.files?.[0]));
el("search").addEventListener("input", renderList);

el("btnClearAll").onclick = async () => {
  if(!confirm("Xo√° to√†n b·ªô d·ªØ li·ªáu trong app?")) return;
  await dbClear();
  await renderList();
};

/* =========================
   Service Worker
========================= */
if("serviceWorker" in navigator){
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(console.error);
  });
}

// init
renderList();
</script>
</body>
</html>
